package org . elasticsearch . search . aggregations . bucket ; import org . elasticsearch . action . search . SearchResponse ; import org . elasticsearch . search . aggregations . Aggregator . SubAggCollectionMode ; import org . elasticsearch . search . aggregations . bucket . terms . Terms ; import org . elasticsearch . search . aggregations . bucket . terms . TermsAggregatorFactory . ExecutionMode ; import org . elasticsearch . test . ESIntegTestCase ; import static org . elasticsearch . search . aggregations . AggregationBuilders . terms ; import static org . elasticsearch . test . hamcrest . ElasticsearchAssertions . assertSearchResponse ; public abstract class AbstractTermsTestCase extends ESIntegTestCase { public String randomExecutionHint ( ) { return randomBoolean ( ) ? null : randomFrom ( ExecutionMode . values ( ) ) . toString ( ) ; } private static long sumOfDocCounts ( Terms terms ) { long sumOfDocCounts = terms . getSumOfOtherDocCounts ( ) ; for ( Terms . Bucket b : terms . getBuckets ( ) ) { sumOfDocCounts + = b . getDocCount ( ) ; } return sumOfDocCounts ; } public void testOtherDocCount ( String . . . fieldNames ) { for ( String fieldName : fieldNames ) { SearchResponse allTerms = client ( ) . prepareSearch ( <str> ) . addAggregation ( terms ( <str> ) . executionHint ( randomExecutionHint ( ) ) . field ( fieldName ) . size ( <int> ) . collectMode ( randomFrom ( SubAggCollectionMode . values ( ) ) ) ) . get ( ) ; assertSearchResponse ( allTerms ) ; Terms terms = allTerms . getAggregations ( ) . get ( <str> ) ; assertEquals ( <int> , terms . getSumOfOtherDocCounts ( ) ) ; final long sumOfDocCounts = sumOfDocCounts ( terms ) ; final int totalNumTerms = terms . getBuckets ( ) . size ( ) ; for ( int size = <int> ; size < totalNumTerms + <int> ; size + = randomIntBetween ( <int> , <int> ) ) { for ( int shardSize = size ; shardSize < = totalNumTerms + <int> ; shardSize + = randomIntBetween ( <int> , <int> ) ) { SearchResponse resp = client ( ) . prepareSearch ( <str> ) . addAggregation ( terms ( <str> ) . executionHint ( randomExecutionHint ( ) ) . field ( fieldName ) . size ( size ) . shardSize ( shardSize ) . collectMode ( randomFrom ( SubAggCollectionMode . values ( ) ) ) ) . get ( ) ; assertSearchResponse ( resp ) ; terms = resp . getAggregations ( ) . get ( <str> ) ; assertEquals ( Math . min ( size , totalNumTerms ) , terms . getBuckets ( ) . size ( ) ) ; assertEquals ( sumOfDocCounts , sumOfDocCounts ( terms ) ) ; } } } } } 
