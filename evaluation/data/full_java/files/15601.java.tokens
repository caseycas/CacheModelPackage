package org . gradle . api . internal . tasks . testing . worker ; import org . gradle . api . Action ; import org . gradle . api . internal . tasks . testing . TestClassProcessor ; import org . gradle . api . internal . tasks . testing . TestClassRunInfo ; import org . gradle . api . internal . tasks . testing . TestResultProcessor ; import org . gradle . api . internal . tasks . testing . WorkerTestClassProcessorFactory ; import org . gradle . internal . Factory ; import org . gradle . messaging . remote . ObjectConnection ; import org . gradle . process . JavaForkOptions ; import org . gradle . process . internal . WorkerProcess ; import org . gradle . process . internal . WorkerProcessBuilder ; import java . io . File ; public class ForkingTestClassProcessor implements TestClassProcessor { private final Factory < WorkerProcessBuilder > workerFactory ; private final WorkerTestClassProcessorFactory processorFactory ; private final JavaForkOptions options ; private final Iterable < File > classPath ; private final Action < WorkerProcessBuilder > buildConfigAction ; private RemoteTestClassProcessor remoteProcessor ; private WorkerProcess workerProcess ; private TestResultProcessor resultProcessor ; public ForkingTestClassProcessor ( Factory < WorkerProcessBuilder > workerFactory , WorkerTestClassProcessorFactory processorFactory , JavaForkOptions options , Iterable < File > classPath , Action < WorkerProcessBuilder > buildConfigAction ) { this . workerFactory = workerFactory ; this . processorFactory = processorFactory ; this . options = options ; this . classPath = classPath ; this . buildConfigAction = buildConfigAction ; } public void startProcessing ( TestResultProcessor resultProcessor ) { this . resultProcessor = resultProcessor ; } public void processTestClass ( TestClassRunInfo testClass ) { if ( remoteProcessor = = null ) { remoteProcessor = forkProcess ( ) ; } remoteProcessor . processTestClass ( testClass ) ; } RemoteTestClassProcessor forkProcess ( ) { WorkerProcessBuilder builder = workerFactory . create ( ) ; builder . setBaseName ( <str> ) ; builder . applicationClasspath ( classPath ) ; builder . setLoadApplicationInSystemClassLoader ( true ) ; builder . worker ( new TestWorker ( processorFactory ) ) ; options . copyTo ( builder . getJavaCommand ( ) ) ; buildConfigAction . execute ( builder ) ; workerProcess = builder . build ( ) ; workerProcess . start ( ) ; ObjectConnection connection = workerProcess . getConnection ( ) ; connection . useParameterSerializer ( TestEventSerializer . create ( ) ) ; connection . addIncoming ( TestResultProcessor . class , resultProcessor ) ; RemoteTestClassProcessor remoteProcessor = connection . addOutgoing ( RemoteTestClassProcessor . class ) ; connection . connect ( ) ; remoteProcessor . startProcessing ( ) ; return remoteProcessor ; } public void stop ( ) { if ( remoteProcessor ! = null ) { remoteProcessor . stop ( ) ; workerProcess . waitForStop ( ) ; } } } 
