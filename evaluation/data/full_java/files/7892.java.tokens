package org . elasticsearch . common ; import org . elasticsearch . test . ESTestCase ; import java . io . BufferedWriter ; import java . io . IOException ; import java . nio . charset . StandardCharsets ; import java . nio . file . Files ; import java . nio . file . Path ; import java . nio . file . StandardOpenOption ; import static org . hamcrest . Matchers . containsString ; public class PidFileTests extends ESTestCase { public void testParentIsFile ( ) throws IOException { Path dir = createTempDir ( ) ; Path parent = dir . resolve ( <str> ) ; try ( BufferedWriter stream = Files . newBufferedWriter ( parent , StandardCharsets . UTF_8 , StandardOpenOption . CREATE_NEW ) ) { stream . write ( <str> ) ; } try { PidFile . create ( parent . resolve ( <str> ) , false ) ; fail ( <str> ) ; } catch ( IllegalArgumentException e ) { assertThat ( e . getMessage ( ) , containsString ( <str> ) ) ; } } public void testPidFile ( ) throws IOException { Path dir = createTempDir ( ) ; Path parent = dir . resolve ( <str> ) ; if ( randomBoolean ( ) ) { Files . createDirectories ( parent ) ; if ( randomBoolean ( ) ) { try { Path link = dir . resolve ( <str> ) ; Files . createSymbolicLink ( link , parent . getFileName ( ) ) ; parent = link ; } catch ( UnsupportedOperationException | IOException | SecurityException ex ) { } } } Path pidFile = parent . resolve ( <str> ) ; long pid = randomLong ( ) ; if ( randomBoolean ( ) & & Files . exists ( parent ) ) { try ( BufferedWriter stream = Files . newBufferedWriter ( pidFile , StandardCharsets . UTF_8 , StandardOpenOption . CREATE_NEW ) ) { stream . write ( <str> ) ; } } final PidFile inst = PidFile . create ( pidFile , false , pid ) ; assertEquals ( pidFile , inst . getPath ( ) ) ; assertEquals ( pid , inst . getPid ( ) ) ; assertFalse ( inst . isDeleteOnExit ( ) ) ; assertTrue ( Files . exists ( pidFile ) ) ; assertEquals ( pid , Long . parseLong ( new String ( Files . readAllBytes ( pidFile ) , StandardCharsets . UTF_8 ) ) ) ; } } 
