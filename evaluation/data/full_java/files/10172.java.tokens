package com . google . common . testing . anotherpackage ; import static com . google . common . truth . Truth . assertThat ; import com . google . common . base . Equivalence ; import com . google . common . base . Function ; import com . google . common . base . Functions ; import com . google . common . base . Joiner ; import com . google . common . base . Predicate ; import com . google . common . collect . Ordering ; import com . google . common . primitives . UnsignedInteger ; import com . google . common . primitives . UnsignedLong ; import com . google . common . testing . ForwardingWrapperTester ; import com . google . common . testing . NullPointerTester ; import junit . framework . AssertionFailedError ; import junit . framework . TestCase ; import java . io . InputStream ; import java . nio . charset . Charset ; import java . util . concurrent . TimeUnit ; import java . util . regex . Pattern ; public class ForwardingWrapperTesterTest extends TestCase { private final ForwardingWrapperTester tester = new ForwardingWrapperTester ( ) ; public void testGoodForwarder ( ) { tester . testForwarding ( Arithmetic . class , new Function < Arithmetic , Arithmetic > ( ) { @Override public Arithmetic apply ( Arithmetic arithmetic ) { return new ForwardingArithmetic ( arithmetic ) ; } } ) ; tester . testForwarding ( ParameterTypesDifferent . class , new Function < ParameterTypesDifferent , ParameterTypesDifferent > ( ) { @Override public ParameterTypesDifferent apply ( ParameterTypesDifferent delegate ) { return new ParameterTypesDifferentForwarder ( delegate ) ; } } ) ; } public void testVoidMethodForwarding ( ) { tester . testForwarding ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) ; } } ) ; } public void testToStringForwarding ( ) { tester . testForwarding ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public String toString ( ) { return runnable . toString ( ) ; } } ; } } ) ; } public void testFailsToForwardToString ( ) { assertFailure ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public String toString ( ) { return <str> ; } } ; } } , <str> ) ; } public void testFailsToForwardHashCode ( ) { tester . includingEquals ( ) ; assertFailure ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public boolean equals ( Object o ) { if ( o instanceof ForwardingRunnable ) { ForwardingRunnable that = ( ForwardingRunnable ) o ; return runnable . equals ( that . runnable ) ; } return false ; } } ; } } , <str> ) ; } public void testEqualsAndHashCodeForwarded ( ) { tester . includingEquals ( ) ; tester . testForwarding ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public boolean equals ( Object o ) { if ( o instanceof ForwardingRunnable ) { ForwardingRunnable that = ( ForwardingRunnable ) o ; return runnable . equals ( that . runnable ) ; } return false ; } @Override public int hashCode ( ) { return runnable . hashCode ( ) ; } } ; } } ) ; } public void testFailsToForwardEquals ( ) { tester . includingEquals ( ) ; assertFailure ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public int hashCode ( ) { return runnable . hashCode ( ) ; } } ; } } , <str> ) ; } public void testFailsToForward ( ) { assertFailure ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( Runnable runnable ) { return new ForwardingRunnable ( runnable ) { @Override public void run ( ) { } } ; } } , <str> , <str> ) ; } public void testRedundantForwarding ( ) { assertFailure ( Runnable . class , new Function < Runnable , Runnable > ( ) { @Override public Runnable apply ( final Runnable runnable ) { return new Runnable ( ) { @Override public void run ( ) { runnable . run ( ) ; runnable . run ( ) ; } } ; } } , <str> , <str> ) ; } public void testFailsToForwardParameters ( ) { assertFailure ( Adder . class , new Function < Adder , Adder > ( ) { @Override public Adder apply ( Adder adder ) { return new FailsToForwardParameters ( adder ) ; } } , <str> , <str> ) ; } public void testForwardsToTheWrongMethod ( ) { assertFailure ( Arithmetic . class , new Function < Arithmetic , Arithmetic > ( ) { @Override public Arithmetic apply ( Arithmetic adder ) { return new ForwardsToTheWrongMethod ( adder ) ; } } , <str> ) ; } public void testFailsToForwardReturnValue ( ) { assertFailure ( Adder . class , new Function < Adder , Adder > ( ) { @Override public Adder apply ( Adder adder ) { return new FailsToForwardReturnValue ( adder ) ; } } , <str> , <str> ) ; } public void testFailsToPropagateException ( ) { assertFailure ( Adder . class , new Function < Adder , Adder > ( ) { @Override public Adder apply ( Adder adder ) { return new FailsToPropagageException ( adder ) ; } } , <str> , <str> ) ; } public void testNotInterfaceType ( ) { try { new ForwardingWrapperTester ( ) . testForwarding ( String . class , Functions . < String > identity ( ) ) ; fail ( ) ; } catch ( IllegalArgumentException expected ) { } } public void testNulls ( ) { new NullPointerTester ( ) . setDefault ( Class . class , Runnable . class ) . testAllPublicInstanceMethods ( new ForwardingWrapperTester ( ) ) ; } private < T > void assertFailure ( Class < T > interfaceType , Function < T , ? extends T > wrapperFunction , String . . . expectedMessages ) { try { tester . testForwarding ( interfaceType , wrapperFunction ) ; } catch ( AssertionFailedError expected ) { for ( String message : expectedMessages ) { assertThat ( expected . getMessage ( ) ) . contains ( message ) ; } return ; } fail ( <str> ) ; } private class ForwardingRunnable implements Runnable { private final Runnable runnable ; ForwardingRunnable ( Runnable runnable ) { this . runnable = runnable ; } @Override public void run ( ) { runnable . run ( ) ; } @Override public String toString ( ) { return runnable . toString ( ) ; } } private interface Adder { int add ( int a , int b ) ; } private static class ForwardingArithmetic implements Arithmetic { private final Arithmetic arithmetic ; public ForwardingArithmetic ( Arithmetic arithmetic ) { this . arithmetic = arithmetic ; } @Override public int add ( int a , int b ) { return arithmetic . add ( a , b ) ; } @Override public int minus ( int a , int b ) { return arithmetic . minus ( a , b ) ; } @Override public String toString ( ) { return arithmetic . toString ( ) ; } } private static class FailsToForwardParameters implements Adder { private final Adder adder ; FailsToForwardParameters ( Adder adder ) { this . adder = adder ; } @Override public int add ( int a , int b ) { return adder . add ( b , a ) ; } @Override public String toString ( ) { return adder . toString ( ) ; } } private static class FailsToForwardReturnValue implements Adder { private final Adder adder ; FailsToForwardReturnValue ( Adder adder ) { this . adder = adder ; } @Override public int add ( int a , int b ) { return adder . add ( a , b ) + <int> ; } @Override public String toString ( ) { return adder . toString ( ) ; } } private static class FailsToPropagageException implements Adder { private final Adder adder ; FailsToPropagageException ( Adder adder ) { this . adder = adder ; } @Override public int add ( int a , int b ) { try { return adder . add ( a , b ) ; } catch ( Exception e ) { return <int> ; } } @Override public String toString ( ) { return adder . toString ( ) ; } } public interface Arithmetic extends Adder { int minus ( int a , int b ) ; } private static class ForwardsToTheWrongMethod implements Arithmetic { private final Arithmetic arithmetic ; ForwardsToTheWrongMethod ( Arithmetic arithmetic ) { this . arithmetic = arithmetic ; } @Override public int minus ( int a , int b ) { return arithmetic . add ( a , b ) ; } @Override public int add ( int a , int b ) { return arithmetic . add ( a , b ) ; } @Override public String toString ( ) { return arithmetic . toString ( ) ; } } private interface ParameterTypesDifferent { void foo ( String s , Runnable r , Number n , Iterable < ? > it , boolean b , Equivalence < String > eq , Exception e , InputStream in , Comparable < ? > c , Ordering < Integer > ord , Charset charset , TimeUnit unit , Class < ? > cls , Joiner joiner , Pattern pattern , UnsignedInteger ui , UnsignedLong ul , StringBuilder sb , Predicate < ? > pred , Function < ? , ? > func , Object obj ) ; } private static class ParameterTypesDifferentForwarder implements ParameterTypesDifferent { private final ParameterTypesDifferent delegate ; public ParameterTypesDifferentForwarder ( ParameterTypesDifferent delegate ) { this . delegate = delegate ; } @Override public void foo ( String s , Runnable r , Number n , Iterable < ? > it , boolean b , Equivalence < String > eq , Exception e , InputStream in , Comparable < ? > c , Ordering < Integer > ord , Charset charset , TimeUnit unit , Class < ? > cls , Joiner joiner , Pattern pattern , UnsignedInteger ui , UnsignedLong ul , StringBuilder sb , Predicate < ? > pred , Function < ? , ? > func , Object obj ) { delegate . foo ( s , r , n , it , b , eq , e , in , c , ord , charset , unit , cls , joiner , pattern , ui , ul , sb , pred , func , obj ) ; } @Override public String toString ( ) { return delegate . toString ( ) ; } } public void testCovariantReturn ( ) { new ForwardingWrapperTester ( ) . testForwarding ( Sub . class , new Function < Sub , Sub > ( ) { @Override public Sub apply ( Sub sub ) { return new ForwardingSub ( sub ) ; } } ) ; } interface Base { CharSequence getId ( ) ; } interface Sub extends Base { @Override String getId ( ) ; } private static class ForwardingSub implements Sub { private final Sub delegate ; ForwardingSub ( Sub delegate ) { this . delegate = delegate ; } @Override public String getId ( ) { return delegate . getId ( ) ; } @Override public String toString ( ) { return delegate . toString ( ) ; } } private interface Equals { @Override boolean equals ( Object obj ) ; @Override int hashCode ( ) ; @Override String toString ( ) ; } private static class NoDelegateToEquals implements Equals { private static Function < Equals , Equals > WRAPPER = new Function < Equals , Equals > ( ) { @Override public NoDelegateToEquals apply ( Equals delegate ) { return new NoDelegateToEquals ( delegate ) ; } } ; private final Equals delegate ; NoDelegateToEquals ( Equals delegate ) { this . delegate = delegate ; } @Override public String toString ( ) { return delegate . toString ( ) ; } } public void testExplicitEqualsAndHashCodeNotDelegatedByDefault ( ) { new ForwardingWrapperTester ( ) . testForwarding ( Equals . class , NoDelegateToEquals . WRAPPER ) ; } public void testExplicitEqualsAndHashCodeDelegatedWhenExplicitlyAsked ( ) { try { new ForwardingWrapperTester ( ) . includingEquals ( ) . testForwarding ( Equals . class , NoDelegateToEquals . WRAPPER ) ; } catch ( AssertionFailedError expected ) { return ; } fail ( <str> ) ; } private interface ChainingCalls { ChainingCalls chainingCall ( ) ; ChainingCalls nonChainingCall ( ) ; } private static class ForwardingChainingCalls implements ChainingCalls { final ChainingCalls delegate ; ForwardingChainingCalls ( ChainingCalls delegate ) { this . delegate = delegate ; } @Override public ForwardingChainingCalls chainingCall ( ) { delegate . chainingCall ( ) ; return this ; } @Override public ChainingCalls nonChainingCall ( ) { return delegate . nonChainingCall ( ) ; } @Override public String toString ( ) { return delegate . toString ( ) ; } } public void testChainingCalls ( ) { tester . testForwarding ( ChainingCalls . class , new Function < ChainingCalls , ChainingCalls > ( ) { @Override public ChainingCalls apply ( ChainingCalls delegate ) { return new ForwardingChainingCalls ( delegate ) ; } } ) ; } } 
